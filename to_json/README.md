---
title: "to_json: Pandoc to JSON string conversion within Lua filters"
author: "Julien Dutant"
---

To_json: Pandoc to JSON string conversion within Lua filters
=======

Function to be used in [Pandoc Lua filters](https://pandoc.org/lua-filters.html) to convert a Pandoc AST document object to its native JSON representation string. 

**Note for Windows users**. On Windows, the function uses Powershell to do string replacement. Two calls are needed, and Powershell takes a few seconds to load, so the function is slow. In the future I'd like to make it use python if available. *More importantly*, the function will put the current terminal window in Unicode (UTF8) mode (which may change the terminal's display font too). This might interfere with other commands you're running from the same terminal window (though not with Pandoc, which works better in utf8 mode). There is no way to revert the current terminal window to its default state: the only option is to close it and open a new one. If you need to run other tasks in your terminal default font encodings, just do so in separate terminal windows. 

Description
------------

In [Pandoc Lua filters](https://pandoc.org/lua-filters.html), it would sometimes
be useful to be able to convert various Pandoc elements (Para, Str, etc.) to
their native JSON representation. This function does it for entire Pandoc
document objects. 

Why have this? On the command line, we can convert documents to Pandoc's native
JSON representation with `pandoc --to json`. Within a filter, we can convert
files(and strings in some raw format) to Pandoc's native JSON representation
with `pandoc.pipe('pandoc', {"-f", "<format>"}, string)`. But suppose your
filter `myfilter` has been launched by the following command:

```bash 
pandoc -L previous-filters.lua -L myfilter.lua source.md -o output.pdf
```

When this command is run, Pandoc first converts source.md to an Pandoc object
(with Pandoc AST elements like Para, Str etc.). It then applies the filter 
`previous-filters.lua`, and passes the result to your filter `myfilter.lua`. Now suppose your filter needs a JSON representation of parts of the document, 
*including any modification generated by `previous-filters.lua`*. 
Your filter can't simply use `pandoc.pipe('pandoc',...)` on `source.md`, for that would ignore any modification introduced by `previous-filters.lua`. Rather, you want to convert (parts of) the *Pandoc object passed to your filter* to a native JSON representation string, and then run Pandoc on it externally with `pandoc.pipe('pandoc',...)` or `os.execute`. 

Example use cases:

* You're writing a filter that, when used, will generate outputs for sub-parts
  of the document as well as the entire document. 
* You're writing a filter that generates series of documents from a single
  source document: say, letters from a list of names, randomized orders for a 
  list of questions. 

Usage
-----

Copy the function `to_json` (in `to_json.lua`) in your filter.

The file `to_json.lua` can be used as a filter to demonstrate the function. 
Run:

```bash
pandoc -L to_json sample.file
```

Prints out the native JSON representation of `sample.file`. It should give you
the same output as `pandoc -to json sample.file`. 

Developments
------------

# Use more efficient scripting engines in Windows

Use Python and perhaps Perl if available rather than the Windows Powershell.

# Handle all Pandoc AST elements

The function should handle not only elements of the Pandoc type, but other
  elements types (incl Meta, MetaList etc., but not components). Since `run_json_filter` only converts entire Pandoc documents, to do this the function should:

* Recognize if the element is a Meta or body type
* Create a Pandoc AST document, place the element in `meta` or `blocks` as appropriate
* Get the JSON string for that Pandoc AST document
* Extract the relevant part of the resulting JSON string (in a sufficiently safe way to avoid cutting off the coverted code)

